# 섹션 10. 스프링 트랜잭션 전파1 - 기본
## 03. 스프링 트랜잭션 전파 - 전파 기본
`트랜잭션 전파(propagation)`: 트랜잭션 진행 중 추가로 트랜잭션 수행시 어떻데 동작할지 결정하는 것
- 스프링의 경우 `다양한 트랜잭션 전파 옵션`들을 제공  
<br/><br/>

### 외부 트랜잭션 수행 중, 내부 트랜잭션이 추가로 수행
![1](img/img_001.jpg)
- 외부 트랜잭션이 아직 수행 중일 때 내부 트랜잭션이 수행된다.
- `외부/내부`의 표현은 내부 트랜잭션이 상대적으로 밖에 있기 때문이다.
  - 즉, 빨리 시작된 트랜잭션일 수록 밖에 있다고 표현한다.  

![2](img/img_002.jpg)
  - 스프링은 이런 경우 외부/내부 트랜잭션을 하나로 묶어 하나의 트랜잭션으로 만들어 준다.
    - 이것이 기본 동작
    - 옵션을 통해서 다른 동작방식도 선택 가능  
<br/>

#### 물리 트랜잭션과 논리 트랜잭션
![3](img/img_003.jpg)
- 스프링에서는 이해를 위해 `논리 트랜잭션`과 `물리 트랜잭션`으로 개념을 나누었다.
  - 논리 트랜잭션들은 물리 트랜잭션으로 묶인다.
  - `물리 트랜잭션`: 실제 DB 에 적용되는 트랜잭션을 뜻 함, 실제 커넥션을 통해 트랜잭션 시작하고, 커밋/롤백하는 단위
  - `논리 트랜잭션`: 트랜잭션 매니저를 통해 트랜잭션을 사용하는 단위
- 이러한 개념은 트랜잭션 진행 중 내부에 추가로 트랜잭션을 사용하는 경우에 나타남
- 개념을 나눈 이유는 트랜잭션 사용 중 내부에 트랜잭션이 사용되면 여러 복잡한 상황이 나타날 수 있는데 개념을 도입해 아래의 원칙을 적용하기 위함이다.
  - `원칙1`: 모든 논리 트랜잭션이 커밋 되어야 물리 트랜잭션이 커밋된다.
  - `원칙2`: 하나의 논리 트랜잭션이라도 롤백이 되면 물리 트랜잭션은 롤백된다.
  - 즉, 모튼 트랜잭션 매니저를 커밋해야 물리 트랜잭션이 커밋될 수 있음
    - 하나의 트랜잭션 매니저라도 롤백되면 물리 트랜잭션은 롤백 됨  
<br/><br/>

### 그림으로 정리
![4](img/img_004.jpg)
- 모든 논리 트랜잭션 커밋 --> 물리 트랜잭션 커밋  

![5](img/img_005.jpg)
- 외부 논리 트랜잭션 롤백 --> 물리 트랜잭션 롤백  

![6](img/img_006.jpg)
- 내부 논리 트랜잭션 롤백 --> 물리 트랜잭션 롤백  
<br/><br/><br/>

## 08. 스프링 트랜잭션 전파 - 다양한 전파 옵션
트랜잭션 전파 기본 옵션은 `REQUIRED`가 사용되며 그 밖의 다양한 옵션들이 제공된다.
- 하지만 실무에서는 아주 가끔 사용되거나 거의 사용하지 않는다.  
<br/>

#### REQUIRED
가장 많이 사용되는 `기본 설정`, 기존 트랜잭션이 없다면 생성하고 있다면 참여하도록 한다.
- `트랜잭션이 필수`이기에 없으면 생성, 있다면 참여한다.  
<br/>

#### REQUIRES_NEW
항상 새로운 트랜잭션을 생성한다.
- 기존 트랜잭션의 유무와 상관 없이 항상 새로운 트랜잭션을 생성한다.  
<br/>

#### SUPPORT
트랜잭션을 지원하는 옵션, 기존 트랜잭션이 없다면 없는대로 진행하고 있다면 참여한다.
- 없는대로 진행한다는 말은 트랜잭션 없이 진행한다는 뜻이다.  
<br/>

#### NOT_SUPPORT
트랜잭션을 지원하지 않는 옵션, 기존 트랜잭션의 유무와 상관없이 트랜잭션 없이 진행한다.
- 기존 트랜잭션이 있는 경우 해당 트랜잭션을 보류한 상태로 진행한다.  
<br/>

#### MANDATORY
의무사항 옵션, 트랜잭션이 반드시 존재해야함
- 기존 트랜잭션이 없다면 `IllegalTransactionStateException` 예외가 발생한다.
- 기존 트랜잭션이 있을 경우 해당 트랜잭션에 참여한다.  
<br/>

#### NEVER
트랜잭션을 사용하지 않는다는 의미, 기존 트랜잭션이 있다면 예외가 발생한다.
- 기존 트랜잭션도 허용하지 않는 강한 부정의 의미를 가진다.
- 기존 트랜잭션이 존재한다면 `IllegalTransactionStateException` 예외가 발생한다.  
<br/>

#### NESTED
- 기존 트랜잭션 없음 : 신규 트랜잭션을 생성
- 기존 트랜잭션 있음 : 중첩 트랜잭션을 생성
  - 중첩 트랜잭션은 외부 트랜잭션의 영향을 받지만, 중첩 트랜잭션은 외부에 영향을 주지 않는다.
  - 중첩 트랜잭션이 롤백 되어도 외부 트랜잭션은 커밋할 수 있다.
  - 외부 트랜잭션이 롤백 되면 중첩 트랜잭션도 함께 롤백된다.
- 참고
  - JDBC savepoint 기능을 사용한다. DB 드라이버에서 해당 기능을 지원하는지 확인이 필요하다.
  - 중첩 트랜잭션은 JPA 에서 사용할 수 없음  
<br/><br/>

### 트랜잭션 전파와 옵션
`isolation`, `timeout`, `readOnly`는 트랜잭션이 시작될 때만 적용된다.
- 트랜잭션에 참여할 경우에는 적용되지 않음
- ex) `REQUIRED`를 통한 트랜잭션 시작이나 `REQUIRES_NEW`를 통한 트랜잭션 시작 시점에만 적용이 된다.
